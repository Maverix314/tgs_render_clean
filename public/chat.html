<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Guru Speaks ‚Äî Prototype Chat</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 600px; margin: 40px auto; }
    #chat-box {
      border: 1px solid #ccc;
      padding: 1em;
      height: 300px;
      overflow-y: auto;
      resize: both;
    }
    .user { color: #333; margin-bottom: 0.5em; }
    .guru { color: #0077aa; margin-bottom: 1em; }
    textarea, button { padding: 0.5em; font-size: 1em; width: 100%; box-sizing: border-box; }
  </style>
</head>
<body>
  <h1>üïâÔ∏è The Guru Speaks</h1>
<div class="session-loader">
  <label for="session-select">Previous sessions:</label>
  <select id="session-select">
    <option value="">-- Select a session --</option>
  </select>
  <button id="load-session-btn">Load Session</button>
</div>

  <div id="chat-box"></div>
<div class="chat-controls">
  <button id="export-btn">Export Transcript</button>
</div>

  <textarea id="user-input" placeholder="What's on your mind?" rows="2"></textarea>
  <button onclick="sendMessage()">Send</button>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <script>


  // --- Create a session in Supabase when page loads ---
  const supabaseUrl = 'https://osuekyacbisnicdhtjbd.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zdWVreWFjYmlzbmljZGh0amJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODUxMTEsImV4cCI6MjA3Nzg2MTExMX0.V_DyJzoVXp1fHljyJN-tfwkSGsrOLJXixVqi9wgO2Sc';
  const { createClient } = window.supabase;
  const supabase = createClient(supabaseUrl, supabaseKey);

  let sessionId = null;

async function createSession(userName) {
  const { data, error } = await supabase
    .from('sessions')
    .insert([{ name: userName, started_at: new Date() }])
    .select()
    .single();

  if (error) {
    console.error('Session creation failed:', error);
    return;
  }

  sessionId = data.session_id;
  console.log(`New session created for ${userName}:`, sessionId);
}


  // Run it as soon as the page loads
let userName = localStorage.getItem("userName");

if (!userName) {
  userName = prompt("What‚Äôs your name?");
  if (userName) localStorage.setItem("userName", userName);
}

if (userName) {
  createSession(userName);
} else {
  alert("You must enter a name to start chatting.");
}


  // --- Save a message to the 'messages' table ---
  async function saveMessage(role, content) {
    if (!sessionId) return;  // safety check
    const { error } = await supabase
      .from('messages')
      .insert([{ session_id: sessionId, role, content }]);
    if (error) console.error('Supabase insert failed:', error);
  }



    async function sendMessage() {
      const input = document.getElementById('user-input');
      const message = input.value.trim();
      if (!message) return;

      const chatBox = document.getElementById('chat-box');
      chatBox.innerHTML += `<div class='user'><b>You:</b> ${message}</div>`;
      input.value = '';

      try {
        const response = await fetch('https://the-guru-speaks.onrender.com/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        const data = await response.json();
        chatBox.innerHTML += `<div class='guru'><b>The Guru:</b> ${data.reply}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
      } catch (error) {
        chatBox.innerHTML += `<div class='guru'><b>Error:</b> Could not reach the server.</div>`;
      }
    }

async function sendMessage() {
  const input = document.getElementById('user-input');
  const message = input.value.trim();
  if (!message) return;

  const chatBox = document.getElementById('chat-box');
  chatBox.innerHTML += `<div class='user'><b>You:</b> ${message}</div>`;
  input.value = '';

  // üü¢ Save the user message
  await saveMessage('user', message);

  try {
    const response = await fetch('https://the-guru-speaks.onrender.com/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message })
    });

    const data = await response.json();
    chatBox.innerHTML += `<div class='guru'><b>The Guru:</b> ${data.reply}</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;

    // üü¢ Save the Guru reply
    await saveMessage('assistant', data.reply);

  } catch (error) {
    chatBox.innerHTML += `<div class='guru'><b>Error:</b> Could not reach the server.</div>`;
  }
}


async function exportTranscript() {
  if (!sessionId) {
    alert("No active session found.");
    return;
  }

  const { data, error } = await supabase
    .from('messages')
    .select('role, content, created_at')
    .eq('session_id', sessionId)
    .order('created_at', { ascending: true });

  if (error) {
    console.error('Export failed:', error);
    alert("Error fetching messages.");
    return;
  }

  // Helper: escape CSV fields per RFC 4180
  function toCsvField(value) {
    if (value === null || value === undefined) return '""';
    // Convert to string, remove newlines (or replace with spaces),
    // escape internal quotes by doubling them, then wrap in quotes.
    const str = String(value).replace(/\r?\n/g, ' ');
    const escaped = str.replace(/"/g, '""');
    return `"${escaped}"`;
  }

  const headers = ['role', 'content', 'created_at'];
  const rows = [headers]
    .concat(data.map(row => [row.role, row.content, row.created_at]));

  // Add BOM so Excel opens UTF-8 correctly
  const csvContent =
    '\uFEFF' +
    rows.map(r => r.map(toCsvField).join(',')).join('\n');

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `GuruTranscript_${sessionId}.csv`;
  link.click();
}



    // Enable Enter-to-send
    document.getElementById('user-input').addEventListener('keydown', function (event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });



// --- Load previous sessions into the dropdown ---
async function populateSessionList() {
  const select = document.getElementById("session-select");

  // Get recent sessions
  const { data: sessions, error } = await supabase
    .from("sessions")
    .select("session_id, started_at")
    .order("started_at", { ascending: false })
    .limit(20);

  if (error) {
    console.error("Error fetching sessions:", error);
    return;
  }

  // Build the dropdown
  select.innerHTML = '<option value="">-- Select a session --</option>';

  for (const s of sessions) {
    // fetch first user message
    const { data: firstMsg } = await supabase
      .from("messages")
      .select("content")
      .eq("session_id", s.session_id)
      .eq("role", "user")
      .order("created_at", { ascending: true })
      .limit(1);

    const preview =
      firstMsg && firstMsg.length > 0
        ? firstMsg[0].content.slice(0, 40) +
          (firstMsg[0].content.length > 40 ? "..." : "")
        : "No messages yet";

    const option = document.createElement("option");
    const date = new Date(s.started_at).toLocaleString();
    option.value = s.session_id;
    option.textContent = `${date} ‚Äî ${preview}`;
    select.appendChild(option);
  }
}


// --- Load messages for a selected session ---
async function loadSessionMessages(targetSessionId) {
  const chatBox = document.getElementById("chat-box");
  chatBox.innerHTML = "";

  const { data, error } = await supabase
    .from("messages")
    .select("role, content, created_at")
    .eq("session_id", targetSessionId)
    .order("created_at", { ascending: true });

  if (error) {
    console.error("Error loading session:", error);
    return;
  }

  data.forEach(msg => {
    const div = document.createElement("div");
    div.className = msg.role;
    div.innerHTML = `<b>${msg.role === "user" ? "You" : "The Guru"}:</b> ${msg.content}`;
    chatBox.appendChild(div);
  });

  chatBox.scrollTop = chatBox.scrollHeight;
}


    document.getElementById("export-btn").addEventListener("click", exportTranscript);

// Load the list of previous sessions when the page opens
populateSessionList();

// Handle "Load Session" button
document.getElementById("load-session-btn").addEventListener("click", () => {
  const select = document.getElementById("session-select");
  const selectedId = select.value;
  if (selectedId) {
    loadSessionMessages(selectedId);
  } else {
    alert("Please select a session first.");
  }
});


  </script>
</body>
</html>
